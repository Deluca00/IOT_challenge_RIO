<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Dashboard Medical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

    body {
      font-family: 'Roboto Mono', monospace;
    }

    @keyframes pulse-low {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(229, 57, 53, .35);
      }

      50% {
        box-shadow: 0 0 18px 6px rgba(229, 57, 53, .25);
      }
    }

    .pulse-low {
      animation: pulse-low 1.6s infinite;
    }


    .camera-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
    }

    .camera-modal.open {
      display: flex;
    }

    .camera-grid {
      width: 100%;
      max-width: 1100px;
      background: white;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .camera-card {
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      aspect-ratio: 4/3;
      border: 4px solid #43a047;
      /* viền màu xanh */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      /* đổ bóng nhẹ */
      /* hoặc 4/3 */
    }

    .camera-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .container {
      max-width: 960px;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    @media (min-width: 640px) {
      .container {
        padding-left: 2rem;
        padding-right: 2rem;
      }
    }

    .grid {
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      .grid {
        gap: 2rem;
      }
    }

    /* === Camera align tools === */
    .cam-wrap {
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 4/3
    }

    .cam-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform-origin: center center;
      /* dùng biến để xoay/zoom/kéo */
      --rot: 0deg;
      --sx: 1;
      --tx: 0px;
      --ty: 0px;
      transform: translate(var(--tx), var(--ty)) scale(var(--sx)) rotate(var(--rot));
    }

    .cam-toolbar {
      position: absolute;
      top: .5rem;
      right: .5rem;
      z-index: 10;
      display: flex;
      gap: .25rem;
      background: rgba(0, 0, 0, .55);
      padding: .25rem .35rem;
      border-radius: .5rem
    }

    .cam-btn {
      color: #fff;
      font-size: .85rem;
      line-height: 1;
      padding: .25rem .4rem;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, .25);
      border-radius: .35rem;
      cursor: pointer
    }

    .cam-label {
      position: absolute;
      top: .5rem;
      left: .5rem;
      z-index: 10;
      background: rgba(0, 0, 0, .6);
      color: #fff;
      font-size: .75rem;
      padding: .2rem .45rem;
      border-radius: .35rem
    }
  </style>
</head>

<body class="bg-white text-gray-900 select-none">
  <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-6 pb-28">
    <div class="flex justify-between items-start mb-2">
      <div class="text-xs text-gray-500 font-semibold">
        Mar 17 dic
      </div>
    </div>
    <div class="flex flex-col items-center mb-2">
      <div class="text-3xl sm:text-4xl font-extrabold text-[#43a047] tracking-widest mb-1 text-center">RIO TECH</div>
      <div class="flex flex-wrap justify-center gap-x-3 gap-y-2 sm:gap-x-6 text-2xl sm:text-3xl mb-1 w-full">
        <i class="fas fa-user-md text-[#1e88e5]"></i>
        <i class="fas fa-heartbeat text-[#e53935]"></i>
        <i class="fas fa-ambulance text-[#1e88e5]"></i>
        <i class="fas fa-stethoscope text-[#43a047]"></i>
        <i class="fas fa-notes-medical text-[#43a047]"></i>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
      <div class="space-y-4 md:space-y-6">
        <div
          class="bg-[#e8f5e9] border-[#43a047] shadow-lg shadow-[#43a047]/20 rounded-2xl p-4 sm:p-6 w-full border-4 mx-auto transition hover:scale-[1.01]">
          <div class="flex flex-col sm:flex-row justify-between items-center sm:items-center mb-4 gap-2">
            <div class="flex items-center space-x-2">
              <img alt="Cloud icon" class="w-8 h-8 sm:w-10 sm:h-10"
                src="https://placehold.co/40x40/png?text=Cloud+Icon" />
              <div class="text-gray-700 text-xs font-semibold">
                Nebbia, 7°C
              </div>
            </div>
            <div class="text-gray-900 text-4xl sm:text-5xl font-bold tracking-wide leading-none" id="vn-clock">
              02:18
            </div>
          </div>
          <div class="text-gray-500 text-xs font-semibold mb-2 text-center sm:text-left">
            17/12/2024
          </div>
          <div class="space-y-2">
            <div class="flex items-center space-x-2 text-xs font-semibold">
              <div class="w-12 text-gray-700">Mar</div>
              <div class="text-[#e53935]">☀️</div>
              <div class="w-6 text-right text-gray-700">7°C</div>
              <div class="flex-1 h-3 rounded-full bg-[#e53935]/20 relative">
                <div class="absolute top-0 left-0 h-3 rounded-full bg-[#e53935]" style="width: 70%"></div>
              </div>
              <div class="w-6 text-left text-gray-700">15°C</div>
            </div>
            <div class="flex items-center space-x-2 text-xs font-semibold">
              <div class="w-12 text-gray-700">Mer</div>
              <div class="text-[#43a047]">☀️</div>
              <div class="w-6 text-right text-gray-700">7°C</div>
              <div class="flex-1 h-3 rounded-full bg-[#43a047]/20 relative">
                <div class="absolute top-0 left-0 h-3 rounded-full bg-[#43a047]" style="width: 70%"></div>
              </div>
              <div class="w-6 text-left text-gray-700">15°C</div>
            </div>
            <div class="flex items-center space-x-2 text-xs font-semibold">
              <div class="w-12 text-gray-700">Gio</div>
              <div class="text-[#1e88e5]">☀️</div>
              <div class="w-6 text-right text-gray-700">7°C</div>
              <div class="flex-1 h-3 rounded-full bg-[#1e88e5]/20 relative">
                <div class="absolute top-0 left-0 h-3 rounded-full bg-[#1e88e5]" style="width: 75%"></div>
              </div>
              <div class="w-6 text-left text-gray-700">16°C</div>
            </div>
          </div>
          <div class="flex flex-wrap justify-between mt-6 space-x-1 sm:space-x-3 text-gray-700 text-lg sm:text-xl">
            <button aria-label="Home lock" class="rounded-full p-2 bg-[#43a047]/80 hover:bg-[#43a047] transition">
              <i class="fas fa-lock"></i>
            </button>
            <button aria-label="Red circle" class="rounded-full p-2 bg-[#e53935]/80 hover:bg-[#e53935] transition">
              <i class="fas fa-heartbeat"></i>
            </button>
            <button aria-label="Leaf icon" class="rounded-full p-2 bg-[#43a047]/80 hover:bg-[#43a047] transition">
              <i class="fas fa-user-md"></i>
            </button>
            <button aria-label="Game controller" class="rounded-full p-2 bg-[#1e88e5]/80 hover:bg-[#1e88e5] transition">
              <i class="fas fa-ambulance"></i>
            </button>
            <button aria-label="Settings" class="rounded-full p-2 bg-[#1e88e5]/80 hover:bg-[#1e88e5] transition">
              <i class="fas fa-cog"></i>
            </button>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full mx-auto">
          <div class="flex flex-col justify-center items-center sm:items-start">
            <style>
              @keyframes pulse-medical {

                0%,
                100% {
                  box-shadow: 0 0 0 0 rgba(30, 136, 229, 0.4);
                }

                50% {
                  box-shadow: 0 0 24px 8px rgba(30, 136, 229, 0.25);
                }
              }

              .medical-animate {
                animation: pulse-medical 1.8s infinite;
              }

              @keyframes rotate-medical {
                0% {
                  transform: rotate(-10deg);
                }

                50% {
                  transform: rotate(10deg);
                }

                100% {
                  transform: rotate(-10deg);
                }
              }

              .medical-rotate {
                animation: rotate-medical 2.2s infinite;
              }

              @keyframes glow-medical {

                0%,
                100% {
                  filter: drop-shadow(0 0 0px #43a04788);
                }

                50% {
                  filter: drop-shadow(0 0 16px #43a047cc);
                }
              }

              .medical-glow {
                animation: glow-medical 1.5s infinite;
              }

              @keyframes bounce-medical {

                0%,
                100% {
                  transform: translateY(0);
                }

                50% {
                  transform: translateY(-10px);
                }
              }

              .medical-bounce {
                animation: bounce-medical 1.2s infinite;
              }

              @keyframes spin-slow {
                0% {
                  transform: rotate(0);
                }

                100% {
                  transform: rotate(360deg);
                }
              }

              .animate-spin-slow {
                animation: spin-slow 4s linear infinite;
              }

              @keyframes heartbeat-scale {

                0%,
                100% {
                  transform: scale(1);
                }

                20% {
                  transform: scale(1.18);
                }

                40% {
                  transform: scale(0.95);
                }

                60% {
                  transform: scale(1.12);
                }

                80% {
                  transform: scale(0.98);
                }
              }

              .heartbeat-real {
                animation: heartbeat-scale 1.1s infinite;
              }

              @keyframes shimmer {
                0% {
                  opacity: 0.7;
                }

                50% {
                  opacity: 1;
                  filter: blur(2px);
                }

                100% {
                  opacity: 0.7;
                }
              }

              .shimmer {
                animation: shimmer 1.3s infinite;
              }

              @keyframes float-particle {
                0% {
                  opacity: 0;
                  transform: translateY(30px) scale(0.7);
                }

                10% {
                  opacity: 1;
                }

                80% {
                  opacity: 1;
                }

                100% {
                  opacity: 0;
                  transform: translateY(-60px) scale(1.2);
                }
              }

              .particle {
                position: absolute;
                left: 50%;
                color: #b3e5fc;
                font-size: 1.1rem;
                pointer-events: none;
                z-index: 30;
              }

              .particle1 {
                animation: float-particle 2.8s linear infinite;
                animation-delay: 0s;
              }

              .particle2 {
                animation: float-particle 2.8s linear infinite;
                animation-delay: 0.7s;
                left: 60%;
              }

              .particle3 {
                animation: float-particle 2.8s linear infinite;
                animation-delay: 1.4s;
                left: 40%;
              }
            </style>
            <div class="relative flex items-center justify-center w-20 h-28 sm:w-[100px] sm:h-[140px]">
              <span class="particle particle1 shimmer" style="top:80px;">●</span>
              <span class="particle particle2 shimmer" style="top:100px;">●</span>
              <span class="particle particle3 shimmer" style="top:120px;">●</span>
              <span
                class="absolute left-1/2 top-2 -translate-x-1/2 text-[#e53935] text-3xl medical-animate medical-glow heartbeat-real z-30">
                <i class="fas fa-heartbeat"></i>
              </span>
              <span
                class="absolute left-1/2 top-10 -translate-x-1/2 text-[#43a047] text-3xl medical-rotate medical-bounce shimmer z-30">
                <i class="fas fa-stethoscope"></i>
              </span>
              <span
                class="absolute left-1/2 top-20 -translate-x-1/2 text-[#1e88e5] text-3xl animate-spin-slow medical-glow shimmer z-30">
                <i class="fas fa-user-md"></i>
              </span>
              <span
                class="absolute left-1/2 top-[90px] -translate-x-1/2 text-[#e53935] text-2xl medical-bounce shimmer z-30">
                <i class="fas fa-briefcase-medical"></i>
              </span>
              <span
                class="absolute left-1/2 top-[110px] -translate-x-1/2 text-[#43a047] text-xl medical-animate shimmer z-30">
                <i class="fas fa-plus-circle"></i>
              </span>
              <div
                class="absolute inset-0 rounded-lg bg-gradient-to-b from-white/90 via-[#e3f2fd]/70 to-[#e8f5e9]/80 border-2 border-[#43a047] shadow-2xl shadow-[#43a047]/40 z-10">
              </div>
              <div class="absolute left-2 top-2 w-3/4 h-2 rounded-full bg-white/60 shimmer z-40"></div>
            </div>
          </div>
          <div class="flex flex-col space-y-2 sm:space-y-3 w-full">
            <button
              class="flex items-center space-x-2 bg-[#ffebee] border border-[#e53935] rounded-full px-4 py-2 text-xs font-semibold shadow shadow-[#e53935]/10">
              <i class="fas fa-heartbeat text-[#e53935]"></i>
              <span>Nhịp Tim</span>
              <span class="ml-auto text-[#e53935]">Bình thường</span>
            </button>
            <button
              class="flex items-center space-x-2 bg-[#e3f2fd] border border-[#1e88e5] rounded-full px-4 py-2 text-xs font-semibold shadow shadow-[#1e88e5]/10">
              <i class="fas fa-tint text-[#1e88e5]"></i>
              <span>Oxy Máu</span>
              <span class="ml-auto text-[#1e88e5]">98%</span>
            </button>
            <button
              class="flex items-center space-x-2 bg-[#e8f5e9] border border-[#43a047] rounded-full px-4 py-2 text-xs font-semibold shadow shadow-[#43a047]/10">
              <i class="fas fa-thermometer-half text-[#43a047]"></i>
              <span>Nhiệt Độ</span>
              <span class="ml-auto text-[#43a047]">36.6°C</span>
            </button>
            <button
              class="flex items-center space-x-2 bg-[#e3f2fd] border border-[#1e88e5] rounded-full px-4 py-2 text-xs font-semibold shadow shadow-[#1e88e5]/10">
              <i class="fas fa-user-nurse text-[#1e88e5]"></i>
              <span>Bác sĩ</span>
              <span class="ml-auto text-[#1e88e5]">Trực</span>
            </button>
          </div>
        </div>
        <div class="flex space-x-2 sm:space-x-4 w-full mt-4 sm:mt-6 mx-auto">
          <button
            class="bg-[#ffebee] border-2 border-[#e53935] rounded-xl p-4 flex-1 flex justify-center items-center text-[#e53935] text-2xl font-bold shadow shadow-[#e53935]/20">
            <i class="fas fa-syringe"></i>
          </button>
          <button
            class="bg-[#e8f5e9] border-2 border-[#43a047] rounded-xl p-4 flex-1 flex justify-center items-center text-[#43a047] text-2xl font-bold shadow shadow-[#43a047]/20">
            <i class="fas fa-stethoscope"></i>
          </button>
          <button
            class="bg-[#e3f2fd] border-2 border-[#1e88e5] rounded-xl p-4 flex-1 flex justify-center items-center text-[#1e88e5] text-2xl font-bold shadow shadow-[#1e88e5]/20">
            <i class="fas fa-user-md"></i>
          </button>
          <button
            class="bg-gray-100 border-2 border-gray-300 rounded-xl p-4 flex-1 flex justify-center items-center text-gray-700 text-2xl font-bold shadow">
            <i class="fas fa-notes-medical"></i>
          </button>
        </div>
      </div>
      <div class="space-y-4 md:space-y-6 md:grid-cols-2">

        <div class="grid grid-cols-2 gap-2 sm:gap-3 w-full mx-auto">
          <div class="camera-card relative">
            <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">Camera Zone 5</span>
            <img id="cam-5" alt="cam 5" src="/barcode_feed/0" class="w-full h-full object-cover">

          </div>
          <div class="camera-card relative">
            <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">Camera Zone 6</span>
            <img id="cam-6" alt="cam 6" src="/barcode_feed/1" class="w-full h-full object-cover">
          </div>

        </div>

        <div class="grid grid-cols-7 gap-2 mt-4  ">
          <!-- Khay A → G -->
          <div class="flex flex-col space-y-2 border-r border-gray-400 pr-2">
            <div id="tray-A1"
              class=" border border-gray-400 rounded h-16 w-16 flex items-center transition-colors duration-300 justify-center">
              A1
            </div>
            <div class="border border-gray-400 rounded h-16 w-16 flex items-center justify-center">
              A2
            </div>
            <div id="tray-A3"
              class="border border-gray-400 rounded h-16 w-16 flex items-center transition-colors duration-300 justify-center">
              A3
            </div>
            <div class="border border-gray-400 rounded h-16 w-16 flex items-center justify-center">
              A4
            </div>
          </div>


          <div class="flex flex-col space-y-2 border-r border-gray-400 pr-2  translate-x-[2px]">
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">B1</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">B2</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">B3</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">B4</div>
          </div>

          <!-- Tương tự cho các cột C → G -->
          <div class="flex flex-col space-y-2 border-r border-gray-400 pr-2">
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">C1</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">C2</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">C3</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">C4</div>
          </div>

          <div class="flex flex-col space-y-2 border-r border-gray-400 pr-2">
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">D1</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">D2</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">D3</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">D4</div>
          </div>

          <div class="flex flex-col space-y-2 border-r border-gray-400 pr-2">
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">E1</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">E2</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">E3</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">E4</div>
          </div>


          <div class="flex flex-col space-y-2 border-r border-gray-400 pr-2">
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">G1</div>
            <div class=" border border-gray-400 rounded h-16 w-16 flex items-center justify-center">G2</div>
            <div class="bg-gray-200 border border-gray-400 rounded h-16 w-16 flex items-center justify-center">G3</div>
            <div class="bg-gray-200 border border-gray-400 rounded h-16 w-16 flex items-center justify-center">G4</div>
          </div>

          <!-- Cột cuối cùng H không cần border-r -->
          <div class="flex flex-col space-y-2">
            <div class="bg-gray-200 border border-gray-400 rounded h-16 w-16 flex items-center justify-center">H1</div>
            <div class="bg-gray-200 border border-gray-400 rounded h-16 w-16 flex items-center justify-center">H2</div>
            <div class="bg-gray-200 border border-gray-400 rounded h-16 w-16 flex items-center justify-center">H3</div>
            <div class="bg-gray-200 border border-gray-400 rounded h-16 w-16 flex items-center justify-center">H4</div>
          </div>
        </div>



      </div>

      <!-- <div class="space-y-4 md:space-y-6">

        <div class="grid grid-cols-1 gap-2 sm:gap-3 w-full mx-auto">
          
        </div>

      </div> -->


    </div>

    <div id="tray-tooltip"
      class="hidden fixed z-50 p-3 rounded-lg bg-white border border-gray-200 shadow-xl text-xs max-w-[240px]"></div>






    <nav
      class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-between sm:justify-center space-x-4 sm:space-x-20 py-2 sm:py-3 px-2 sm:px-0 z-50">
      <button class="text-[#43a047] text-xl sm:text-2xl">
        <i class="fas fa-home"></i>
      </button>
      <button id="btnNhapThuoc" class="text-[#e53935] text-xl sm:text-2xl">
        <i class="fas fa-pills"></i>
      </button>
      <button id="btnBanthuoc" class="text-[#1e88e5] text-xl sm:text-2xl">
        <i class="fas fa-cash-register"></i>
      </button>

      <button id="tdBtn" class="text-[#1e88e5] text-xl sm:text-2xl">
        <i class="fas fa-map-marker-alt"></i>
      </button>
      <button id="Btnthongtinthuoc" class="text-gray-700 text-xl sm:text-2xl">
        <i class="fas fa-notes-medical"></i>
      </button>
    </nav>


    <button id="btnToggleBarcode" class="fixed bottom-16 left-0 right-0 bg-gray-100 border-t border-gray-200 text-gray-700 text-xl sm:text-2xl py-2 sm:py-3 px-2 sm:px-0 z-50">
        Bật/Tắt Barcode
    </button>


    <div id="cameraDiv" class="fixed inset-0 bg-black/70 flex flex-col items-center justify-center hidden z-50 p-4">
      <video id="video" autoplay playsinline
        class="rounded-lg shadow-lg max-w-full max-h-[70vh] border-4 border-[#43a047]"></video>
      <button id="btnCapture"
        class="mt-4 bg-[#e53935] text-white font-bold py-2 px-6 rounded-full shadow-lg opacity-50 cursor-not-allowed"
        disabled>Chụp</button>
      <button id="btnClose" class="mt-2 text-white underline">Đóng</button>
    </div>
    <form id="form" method="POST" action="/scan_barcode">
      <input type="hidden" name="image" id="imageInput">
    </form>
    <div id="cameraModal" class="camera-modal">
      <div class="camera-grid">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold">Camera Medical — 4 view (OpenCV stream)</h3>
          <button class="px-3 py-1 rounded-md bg-red-500 text-white" onclick="closeCameraGrid()">Đóng</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="camera-card relative">
            <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">Camera Zone 1</span>
            <img id="cam-1" alt="cam 1">
          </div>
          <div class="camera-card relative">
            <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">Camera Zone 2</span>
            <img id="cam-2" alt="cam 2">
          </div>
          <div class="camera-card relative">
            <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">Camera Zone 3</span>
            <img id="cam-3" alt="cam 3">
          </div>
          <div class="camera-card relative">
            <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">Camera Zone 4</span>
            <img id="cam-4" alt="cam 4">
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    function updateVNClock() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const vnTime = new Date(utc + (7 * 60 * 60 * 1000));
      let hours = vnTime.getHours();
      let minutes = vnTime.getMinutes();
      hours = hours < 10 ? '0' + hours : hours;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      document.getElementById('vn-clock').textContent = `${hours}:${minutes}`;
    }
    updateVNClock();
    setInterval(updateVNClock, 1000);

    function openCameraGrid() {
      document.getElementById('cameraModal').classList.add('open');
      document.getElementById('cam-1').src = '/video_feed/1';
      document.getElementById('cam-2').src = '/video_feed/2';
      document.getElementById('cam-3').src = '/video_feed/3';
      document.getElementById('cam-4').src = '/video_feed/4';
    }

    function closeCameraGrid() {
      document.getElementById('cameraModal').classList.remove('open');
    }



    const btnNhapThuoc = document.getElementById("btnNhapThuoc");
    const btnbanthuoc = document.getElementById("btnBanthuoc");
    const btnthongtinthuoc = document.getElementById("Btnthongtinthuoc");
    const btntd = document.getElementById("tdBtn");
    const cameraDiv = document.getElementById("cameraDiv");
    const video = document.getElementById("video");
    const btnCapture = document.getElementById("btnCapture");
    const btnClose = document.getElementById("btnClose");
    const form = document.getElementById("form");
    const imageInput = document.getElementById("imageInput");

    let stream = null;

    async function startCamera() {
      btnCapture.disabled = true;
      btnCapture.classList.add("opacity-50", "cursor-not-allowed");
      const constraints = {
        video: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          btnCapture.disabled = false;
          btnCapture.classList.remove("opacity-50", "cursor-not-allowed");
        };
      } catch (err) {
        alert("Không thể mở camera: " + err);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      cameraDiv.classList.add("hidden");
    }

    btnNhapThuoc.addEventListener("click", () => {
      cameraDiv.classList.remove("hidden");
      console.log("Nút thêm thuốc đã được nhấn!");
      startCamera();
    });

    btnbanthuoc.addEventListener("click", () => {
      window.location.href = "/banthuoc";
    });
    btnthongtinthuoc.addEventListener("click", () => {
      window.location.href = "/thongtinthuoc";
    });

    btnCapture.addEventListener("click", () => {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.filter = "contrast(150%) brightness(110%)";
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob((blob) => {
        if (!blob) { console.error("Blob is null"); return; }
        const formData = new FormData();
        formData.append("image", blob, "capture.jpg");
        fetch("/scan_barcode", { method: "POST", body: formData })
          .then(res => {
            if (res.redirected) {
              window.location.href = res.url;
            }
          });
      }, "image/jpeg", 1.0);
      stopCamera();
    });

    btnClose.addEventListener("click", stopCamera);

    btntd.addEventListener("click", () => {
      window.location.href = "/td_page";
    });


    const tooltipEl = document.getElementById('tray-tooltip');
    const trayDetailsCache = new Map();
    const HOVER_DELAY = 80;

    // --- API fetchers ---
    async function fetchTrayDetail(trayId) {
      if (trayDetailsCache.has(trayId)) return trayDetailsCache.get(trayId);
      const res = await fetch(`/api/trays/detail/${trayId}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      trayDetailsCache.set(trayId, data);
      return data;
    }

    async function fetchTraySummary() {
      // Backend trả {"success": true, "trays": {"1": x, "3": y}}
      const res = await fetch('/api/trays/summary', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    // --- Tooltip renderer ---
    function buildTooltipHtml(data) {
      if (!data?.success) return '<div class="text-red-600">Không có dữ liệu</div>';
      const items = data.items || [];
      if (items.length === 0) return '<div class="text-gray-600">Chưa có thuốc trong khay</div>';

      const lines = items.map(it => `
      <div class="flex justify-between gap-2">
        <span class="truncate">${it.name}</span>
        <span class="font-semibold">${it.qty}</span>
      </div>
    `).join('');

      return `
      <div class="mb-1 text-[10px] uppercase tracking-wider text-gray-500">Thuốc trong khay</div>
      <div class="space-y-1 max-h-48 overflow-auto pr-1">${lines}</div>
      <div class="mt-2 pt-2 border-t border-gray-200 flex justify-between text-[11px]">
        <span class="text-gray-600">Tổng</span>
        <span class="font-semibold">${data.total ?? 0}</span>
      </div>
    `;
    }

    function showTooltipNear(el, html) {
      tooltipEl.innerHTML = html;
      tooltipEl.classList.remove('hidden');

      // đặt tooltip lệch phải (nếu tràn sẽ tự canh)
      const rect = el.getBoundingClientRect();
      const gap = 8;

      // tạm hiện để đo kích thước
      tooltipEl.style.top = '0px';
      tooltipEl.style.left = '-9999px';

      // dùng requestAnimationFrame để chắc chắn DOM đã vẽ xong
      requestAnimationFrame(() => {
        const top = Math.max(8, rect.top - tooltipEl.offsetHeight - gap);
        const left = Math.min(
          window.innerWidth - tooltipEl.offsetWidth - 8,
          rect.left + rect.width + gap
        );
        tooltipEl.style.top = `${top}px`;
        tooltipEl.style.left = `${left}px`;
      });
    }

    function hideTooltip() {
      tooltipEl.classList.add('hidden');
    }

    // Gắn listener cho tooltip (chỉ một lần, tránh trùng)
    tooltipEl.addEventListener('mouseenter', () => clearTimeout(tooltipEl._hideTimer));
    tooltipEl.addEventListener('mouseleave', () => hideTooltip());

    // --- Hover handlers cho từng ô ---
    function attachTrayHover(elemId, trayId) {
      const el = document.getElementById(elemId);
      if (!el) return;

      el.addEventListener('mouseenter', async () => {
        clearTimeout(tooltipEl._hideTimer);
        try {
          const data = await fetchTrayDetail(trayId);
          showTooltipNear(el, buildTooltipHtml(data));
        } catch (e) {
          console.error(e);
          showTooltipNear(el, '<div class="text-red-600">Lỗi tải dữ liệu</div>');
        }
      });

      el.addEventListener('mouseleave', () => {
        tooltipEl._hideTimer = setTimeout(hideTooltip, HOVER_DELAY);
      });

      // Tuỳ chọn: hỗ trợ chạm trên mobile để xem tooltip
      el.addEventListener('touchstart', async (ev) => {
        ev.preventDefault();
        try {
          const data = await fetchTrayDetail(trayId);
          showTooltipNear(el, buildTooltipHtml(data));
        } catch (e) {
          console.error(e);
          showTooltipNear(el, '<div class="text-red-600">Lỗi tải dữ liệu</div>');
        }
      }, { passive: false });
    }

    // --- Màu ô theo tồn kho ---
    const trayMapColor = { 'tray-A1': 1, 'tray-A3': 3 };
    const COLOR_CLASSES = [
      'bg-gray-200', 'bg-green-50', 'bg-green-100', 'bg-yellow-50', 'bg-yellow-100',
      'bg-orange-50', 'bg-orange-100', 'bg-red-50', 'bg-red-100',
      'border-gray-400', 'border-green-500', 'border-yellow-500', 'border-orange-500', 'border-red-500'
    ];

    function applyTrayColor(elemId, qty) {
       console.log("applyTrayColor called with:", elemId, qty); 
      const el = document.getElementById(elemId);
      if (!el) return;

      COLOR_CLASSES.forEach(cls => el.classList.remove(cls));
      el.classList.remove('pulse-low');

      // ngưỡng ví dụ:
      if (qty === 0) {
        el.classList.add('bg-red-50', 'border', 'border-red-500', 'pulse-low');
      } else if (qty <= 9) {
        el.classList.add('bg-orange-50', 'border', 'border-orange-500');
      } else if (qty <= 29) {
        el.classList.add('bg-yellow-50', 'border', 'border-yellow-500');
      } else {
        el.classList.add('bg-green-50', 'border', 'border-green-500');
      }
    }

    async function refreshTrayColors() {
      try {
        const data = await fetchTraySummary();
        const trays = data?.trays ?? {};
        console.log("Trays data:", trays); 
        Object.entries(trayMapColor).forEach(([elemId, trayId]) => {
          const qty = Number(trays[String(trayId)] ?? 0);
          applyTrayColor(elemId, qty);
        });
      } catch (e) {
        console.error('Không lấy được tổng số lượng để tô màu:', e);
        // fallback giữ xám
        Object.keys(trayMapColor).forEach(elemId => {
          const el = document.getElementById(elemId);
          if (!el) return;
          COLOR_CLASSES.forEach(cls => el.classList.remove(cls));
          el.classList.add('bg-gray-200', 'border', 'border-gray-400');
        });
      }
    }

    // --- Khởi tạo ---
    attachTrayHover('tray-A1', 1);
    attachTrayHover('tray-A3', 3);
    refreshTrayColors();
    setInterval(refreshTrayColors, 10000);


    const btnToggleBarcode = document.getElementById("btnToggleBarcode");
    btnToggleBarcode.addEventListener("click", () => {
        // Gọi API để bật/tắt barcode
        fetch("/toggle_decode/0", { method: "POST" })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.paused) {
                        btnToggleBarcode.textContent = "Bật Barcode";
                    } else {
                        btnToggleBarcode.textContent = "Tắt Barcode";
                    }
                } else {
                    alert("Lỗi: " + data.error);
                }
            });
    });




  </script>
</body>

</html>